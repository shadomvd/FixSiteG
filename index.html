<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FixSite - Профиль</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        html, body {
            height: 100%;
            background: #0f0f1a;
            color: #ffffff;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 12px;
            background: linear-gradient(180deg, #1e1e2e 0%, #0f0f1a 100%);
            position: relative;
        }
        .content {
            flex-grow: 1;
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .nav-bar {
            width: 100%;
            background: linear-gradient(145deg, #2a2a3a, #1e1e2e);
            padding: 10px 14px;
            margin-bottom: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid rgba(100, 100, 150, 0.2);
        }
        .nav-bar-title {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            text-align: center;
            gap: 6px;
            position: relative;
        }
        .profile-section {
            background: linear-gradient(145deg, #2a2a3a, #1e1e2e);
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 0 6px rgba(100, 100, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(100, 100, 150, 0.3);
            position: relative;
            overflow: hidden;
        }
        .profile-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 20%, rgba(100, 100, 255, 0.2), transparent 70%);
            opacity: 0.3;
            z-index: 0;
        }
        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            background: #1a1a2a;
            border: 2px solid #6464ff;
            cursor: pointer;
            z-index: 1;
        }
        .avatar-upload {
            display: none;
        }
        .profile-username-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            z-index: 1;
            width: 100%;
            max-width: 220px;
        }
        .profile-username-wrapper {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .profile-username {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.2px;
        }
        .profile-verified {
            width: 14px;
            height: 14px;
        }
        .profile-bio {
            font-size: 12px;
            font-weight: 400;
            color: #c9d1d9;
            text-align: center;
            max-width: 100%;
            word-wrap: break-word;
            z-index: 1;
            background: rgba(50, 50, 100, 0.2);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(100, 100, 150, 0.3);
            width: 100%;
            max-width: 260px;
            line-height: 1.2;
        }
        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            padding: 8px 0;
            border-top: 1px solid rgba(100, 100, 150, 0.3);
            border-bottom: 1px solid rgba(100, 100, 150, 0.3);
            z-index: 1;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        .stat-number {
            font-size: 14px;
            font-weight: 600;
            color: #6464ff;
        }
        .stat-label {
            font-size: 10px;
            font-weight: 400;
            color: #8b949e;
        }
        .edit-profile-button {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 14px;
            height: 14px;
            cursor: pointer;
            filter: brightness(0.8);
            z-index: 2;
        }
        .settings-section {
            background: linear-gradient(145deg, #222233, #1a1a2a);
            padding: 14px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 0.5px solid rgba(100, 100, 150, 0.2);
            margin-bottom: 20px;
        }
        .settings-button {
            width: 96%;
            margin: 0 auto;
            padding: 10px;
            background: linear-gradient(145deg, #333344, #222233);
            border: none;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .settings-button img {
            width: 18px;
            height: 18px;
            filter: brightness(0.8);
            transition: filter 0.2s;
        }
        .settings-button:hover {
            background: linear-gradient(145deg, #3a3a4a, #2a2a3a);
            color: #ffffff;
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(100, 100, 255, 0.3);
        }
        .settings-button:hover img {
            filter: brightness(1);
        }
        .settings-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: linear-gradient(145deg, #222233, #1a1a2a);
            padding: 16px;
            border-radius: 16px;
            width: 90%;
            max-width: 360px;
            box-shadow: 0 3px 16px rgba(0, 0, 0, 0.6);
            position: relative;
            border: 1px solid #303044;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            filter: brightness(0.8);
            transition: filter 0.2s, transform 0.2s;
        }
        .modal-close:hover {
            filter: brightness(1);
            transform: rotate(90deg);
        }
        .modal-content h2 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            color: #c9d1d9;
            animation: fadeInElement 0.5s ease forwards;
        }
        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #303044;
            background: #1a1a2a;
            color: #c9d1d9;
            font-size: 13px;
            outline: none;
            resize: none;
            user-select: auto;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.4);
            transition: border-color 0.2s, box-shadow 0.2s;
            animation: fadeInElement 0.5s ease forwards;
        }
        .modal-content input:focus,
        .modal-content textarea:focus {
            border-color: #6464ff;
            box-shadow: 0 0 0 2px rgba(100, 100, 255, 0.2);
        }
        .save-button {
            width: 100%;
            padding: 8px;
            background: linear-gradient(145deg, #6464ff, #4b4bff);
            border: none;
            border-radius: 6px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(100, 100, 255, 0.4);
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            animation: fadeInElement 0.5s ease forwards;
        }
        .save-button:hover {
            background: linear-gradient(145deg, #5a5aff, #4141ff);
            transform: scale(1.02);
            box-shadow: 0 3px 12px rgba(100, 100, 255, 0.5);
        }
        .save-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(100, 100, 255, 0.4);
        }
        @keyframes fadeInElement {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loader {
            border: 4px solid #6464ff;
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-width: 480px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: space-around;
            background: linear-gradient(145deg, #2a2a3a, #1e1e2e);
            padding: 8px 0;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.3);
            z-index: 100;
            border-top: 1px solid rgba(100, 100, 150, 0.2);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaaaaa;
            cursor: pointer;
            width: 33.33%;
            padding: 6px;
            transition: color 0.2s, transform 0.2s;
        }
        .nav-item:hover {
            color: #ffffff;
        }
        .nav-item:active {
            transform: scale(0.95);
        }
        .nav-item img {
            width: 22px;
            height: 22px;
            margin-bottom: 3px;
            filter: brightness(0.5);
            transition: filter 0.2s;
        }
        .nav-item:hover img {
            filter: brightness(1);
        }
        .nav-text {
            font-size: 10px;
            font-weight: 500;
        }
        .nav-item.active {
            color: #6464ff;
        }
        .nav-item.active img {
            filter: brightness(1);
        }
        .post {
            background: linear-gradient(145deg, #222233, #1a1a2a);
            padding: 14px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            border: 0.5px solid rgba(100, 100, 150, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: immerseIn 0.5s ease forwards;
        }
        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 14px rgba(100, 100, 255, 0.2);
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .post-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            background: #1a1a2a;
            border: 1px solid #444455;
            cursor: pointer;
        }
        .post-username-container {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .post-username {
            font-size: 13px;
            font-weight: 600;
            color: #c9d1d9;
        }
        .post-verified {
            width: 14px;
            height: 14px;
        }
        .post-time {
            font-size: 10px;
            color: #8b949e;
            margin-top: 2px;
        }
        .post-image {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            background: #1a1a2a;
            border-radius: 6px;
            border: 1px solid #303044;
            cursor: pointer;
        }
        .post-title {
            font-size: 15px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.3;
            margin-bottom: 4px;
        }
        .post-text {
            font-size: 13px;
            font-weight: 400;
            color: #c9d1d9;
            line-height: 1.4;
        }
        .post-actions {
            display: flex;
            align-items: center;
            gap: 14px;
            padding-top: 8px;
            border-top: 1px solid #303044;
        }
        .action-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #8b949e;
            font-size: 12px;
        }
        .action-item img {
            width: 18px;
            height: 18px;
            filter: brightness(0.7);
        }
        @keyframes immerseIn {
            0% {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
                filter: blur(4px);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }
        @media (min-width: 481px) and (max-width: 767px) {
            .container {
                max-width: 90%;
            }
            .nav-bar {
                max-width: 100%;
            }
            .profile-section {
                max-width: 100%;
            }
            .settings-section {
                max-width: 100%;
            }
            .navigation {
                max-width: 90%;
            }
            .profile-username-container {
                max-width: 260px;
            }
            .profile-bio {
                max-width: 300px;
            }
        }
        @media (min-width: 768px) and (max-width: 1023px) {
            .container {
                max-width: 700px;
            }
            .nav-bar {
                max-width: 100%;
            }
            .profile-section {
                max-width: 100%;
            }
            .settings-section {
                max-width: 100%;
            }
            .navigation {
                max-width: 700px;
            }
            .profile-username-container {
                max-width: 300px;
            }
            .profile-bio {
                max-width: 340px;
            }
        }
        @media (min-width: 1024px) {
            .container {
                max-width: 900px;
            }
            .nav-bar {
                max-width: 100%;
            }
            .profile-section {
                max-width: 100%;
            }
            .settings-section {
                max-width: 100%;
            }
            .navigation {
                max-width: 900px;
            }
            .profile-username-container {
                max-width: 340px;
            }
            .profile-bio {
                max-width: 380px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loader"></div>
    </div>
    <div class="container">
        <div class="nav-bar">
            <div class="nav-bar-title">
                Профиль
            </div>
        </div>
        <div class="content">
            <div class="profile-section">
                <img class="profile-avatar" id="profile-avatar" src="https://img.icons8.com/ios/50/ffffff/user.png" alt="avatar"/>
                <input type="file" id="avatar-upload" class="avatar-upload" accept="image/*">
                <div class="profile-username-container">
                    <div class="profile-username-wrapper">
                        <div class="profile-username" id="profile-username">Guest</div>
                        <img class="profile-verified" id="profile-verified" src="https://img.icons8.com/color/48/instagram-verification-badge.png" alt="verified" style="display: none;"/>
                    </div>
                    <div class="profile-bio" id="profile-bio">О себе...</div>
                </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="stat-subscriptions">0</div>
                        <div class="stat-label">Подписки</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-subscribers">0</div>
                        <div class="stat-label">Подписчики</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-friends">0</div>
                        <div class="stat-label">Друзья</div>
                    </div>
                </div>
                <img class="edit-profile-button" id="edit-profile-button" src="https://img.icons8.com/ios/50/ffffff/edit--v1.png" alt="edit"/>
            </div>
            <div class="settings-section">
                <button class="settings-button" id="settings-button">
                    <img src="https://img.icons8.com/ios/50/ffffff/settings.png" alt="settings"/>
                    Настройки
                </button>
                <button class="settings-button" id="favorites-button">
                    <img src="https://img.icons8.com/ios/50/ffffff/star--v1.png" alt="favorites"/>
                    Избранное
                </button>
                <button class="settings-button" id="logout-button">
                    <img src="https://img.icons8.com/ios/50/ffffff/logout-rounded.png" alt="logout"/>
                    Выйти
                </button>
            </div>
            <div id="user-posts"></div>
        </div>
        <div class="navigation">
            <div class="nav-item">
                <img src="https://img.icons8.com/ios/50/ffffff/leaderboard.png" alt="leaderboard"/>
                <span class="nav-text">Лидеры</span>
            </div>
            <div class="nav-item">
                <img src="https://img.icons8.com/ios/50/ffffff/home.png" alt="home"/>
                <span class="nav-text">Главное</span>
            </div>
            <div class="nav-item active">
                <img src="https://img.icons8.com/ios/50/ffffff/user.png" alt="profile"/>
                <span class="nav-text">Профиль</span>
            </div>
        </div>
    </div>
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <img class="modal-close" id="modal-close" src="https://img.icons8.com/ios/50/ffffff/close-window.png" alt="close"/>
            <h2>Редактировать профиль</h2>
            <input type="text" id="edit-username" placeholder="Имя пользователя (макс. 16 символов)" maxlength="16">
            <textarea id="edit-bio" placeholder="О себе (макс. 100 символов)" maxlength="100"></textarea>
            <button class="save-button" id="save-profile">Сохранить</button>
        </div>
    </div>
    <script type="module">
        // Импорт функций Firebase
        import { auth, db, onAuthStateChanged, doc, getDoc, setDoc, updateDoc, signOut, collection, query, where, orderBy, onSnapshot, getDocs } from './database.js';

        // Объявление переменных DOM
        const profileAvatar = document.querySelector('#profile-avatar');
        const avatarUpload = document.querySelector('#avatar-upload');
        const profileUsername = document.querySelector('#profile-username');
        const profileVerified = document.querySelector('#profile-verified');
        const profileBio = document.querySelector('#profile-bio');
        const statSubscriptions = document.querySelector('#stat-subscriptions');
        const statSubscribers = document.querySelector('#stat-subscribers');
        const statFriends = document.querySelector('#stat-friends');
        const editProfileButton = document.querySelector('#edit-profile-button');
        const settingsButton = document.querySelector('#settings-button');
        const favoritesButton = document.querySelector('#favorites-button');
        const logoutButton = document.querySelector('#logout-button');
        const editProfileModal = document.querySelector('#edit-profile-modal');
        const modalClose = document.querySelector('#modal-close');
        const editUsername = document.querySelector('#edit-username');
        const editBio = document.querySelector('#edit-bio');
        const saveProfile = document.querySelector('#save-profile');
        const userPosts = document.querySelector('#user-posts');
        const loadingOverlay = document.querySelector('#loading-overlay');
        const navItems = document.querySelectorAll('.nav-item');

        const IMGUR_CLIENT_ID = '8ea63c636bd153e';
        let currentUser = null;
        let unsubscribeSnapshot = null;

        // Проверка загрузки Firebase
        if (!auth || !db || !onSnapshot) {
            console.error('Firebase не загружен корректно. Проверьте database.js');
            alert('Ошибка загрузки Firebase. Попробуйте позже.');
            loadingOverlay.classList.remove('active');
            window.location.href = 'auth.html'; // Перенаправление вместо return
        }

        // Отслеживание состояния авторизации
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadingOverlay.classList.add('active');
                try {
                    await loadProfile();
                    await loadUserPosts();
                    listenForUserPosts();
                } catch (error) {
                    console.error('Ошибка загрузки профиля или постов:', error);
                    alert('Не удалось загрузить данные профиля. Проверьте соединение.');
                } finally {
                    loadingOverlay.classList.remove('active');
                }
            } else {
                window.location.href = 'auth.html';
            }
        });

        // Загрузка профиля пользователя
        async function loadProfile() {
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userRef);
                let userData = {
                    username: 'Guest',
                    avatar: 'https://img.icons8.com/ios/50/ffffff/user.png',
                    bio: 'О себе...',
                    verify: false,
                    subscriptions: 0,
                    subscribers: 0,
                    friends: 0
                };

                if (userDoc.exists()) {
                    userData = userDoc.data();
                } else {
                    await setDoc(userRef, userData);
                }

                profileAvatar.src = userData.avatar || userData.avatar;
                profileUsername.textContent = userData.username || 'Guest';
                profileBio.textContent = userData.bio || 'О себе...';
                profileVerified.style.display = userData.verify ? 'block' : 'none';
                statSubscriptions.textContent = userData.subscriptions || 0;
                statSubscribers.textContent = userData.subscribers || 0;
                statFriends.textContent = userData.friends || 0;

                localStorage.setItem(`profile_${currentUser.uid}`, JSON.stringify(userData));
            } catch (error) {
                console.error('Ошибка загрузки профиля:', error);
                throw error;
            }
        }

        // Загрузка постов пользователя
        async function loadUserPosts() {
            try {
                const postsQuery = query(collection(db, 'posts'), where('uid', '==', currentUser.uid), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(postsQuery);
                userPosts.innerHTML = '';

                for (const postDoc of querySnapshot.docs) {
                    const postData = postDoc.data();
                    const postId = postDoc.id;
                    renderPost(postData, postId);
                }
            } catch (error) {
                console.error('Ошибка загрузки постов пользователя:', error);
                throw error;
            }
        }

        // Подписка на новые посты пользователя
        function listenForUserPosts() {
            if (unsubscribeSnapshot) unsubscribeSnapshot();

            try {
                const postsQuery = query(collection(db, 'posts'), where('uid', '==', currentUser.uid), orderBy('createdAt', 'desc'));
                unsubscribeSnapshot = onSnapshot(postsQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const postData = change.doc.data();
                            const postId = change.doc.id;
                            const existingPost = document.querySelector(`.post[data-id="${postId}"]`);
                            if (!existingPost) {
                                renderPost(postData, postId, true);
                            }
                        }
                    });
                }, (error) => {
                    console.error('Ошибка подписки на посты пользователя:', error);
                });
            } catch (error) {
                console.error('Ошибка настройки подписки на посты:', error);
            }
        }

        // Обновление времени постов
        function updatePostTimes() {
            const posts = userPosts.querySelectorAll('.post');
            posts.forEach(post => {
                const createdAt = post.dataset.createdAt;
                if (createdAt) {
                    const timeElement = post.querySelector('.post-time');
                    const diff = Date.now() - parseInt(createdAt);
                    const seconds = Math.floor(diff / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const hours = Math.floor(minutes / 60);
                    const days = Math.floor(hours / 24);

                    if (seconds < 60) {
                        timeElement.textContent = `${seconds} сек назад`;
                    } else if (minutes < 60) {
                        timeElement.textContent = `${minutes} мин назад`;
                    } else if (hours < 24) {
                        timeElement.textContent = `${hours} ч назад`;
                    } else {
                        timeElement.textContent = `${days} дн назад`;
                    }
                }
            });
        }

        setInterval(updatePostTimes, 1000);

        // Загрузка аватара
        profileAvatar.addEventListener('click', () => {
            avatarUpload.click();
        });

        avatarUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                loadingOverlay.classList.add('active');
                try {
                    const imageUrl = await uploadToImgur(file);
                    await updateDoc(doc(db, 'users', currentUser.uid), { avatar: imageUrl });
                    profileAvatar.src = imageUrl;
                    const cachedProfile = JSON.parse(localStorage.getItem(`profile_${currentUser.uid}`)) || {};
                    cachedProfile.avatar = imageUrl;
                    localStorage.setItem(`profile_${currentUser.uid}`, JSON.stringify(cachedProfile));
                } catch (error) {
                    console.error('Ошибка загрузки аватара:', error);
                    alert('Не удалось загрузить аватар!');
                } finally {
                    loadingOverlay.classList.remove('active');
                }
            }
        });

        // Загрузка изображения на Imgur
        async function uploadToImgur(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('type', 'file');

            try {
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        Authorization: `Client-ID ${IMGUR_CLIENT_ID}`,
                        Accept: 'application/json'
                    },
                    body: formData
                });
                const data = await response.json();
                if (data.success && data.data.link) {
                    return data.data.link;
                } else {
                    throw new Error('Ошибка загрузки изображения в Imgur');
                }
            } catch (error) {
                console.error('Ошибка загрузки Imgur:', error);
                throw error;
            }
        }

        // Открытие модального окна редактирования профиля
        editProfileButton.addEventListener('click', () => {
            const cachedProfile = JSON.parse(localStorage.getItem(`profile_${currentUser.uid}`)) || {};
            editUsername.value = cachedProfile.username || 'Guest';
            editBio.value = cachedProfile.bio || 'О себе...';
            editProfileModal.classList.add('active');
        });

        // Закрытие модального окна
        modalClose.addEventListener('click', () => {
            editProfileModal.classList.remove('active');
        });

        // Сохранение профиля
        saveProfile.addEventListener('click', async () => {
            const username = editUsername.value.trim();
            const bio = editBio.value.trim();

            if (!username) {
                alert('Имя пользователя не может быть пустым!');
                return;
            }

            loadingOverlay.classList.add('active');
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const updatedData = { username, bio };
                await updateDoc(userRef, updatedData);

                profileUsername.textContent = username;
                profileBio.textContent = bio;

                const cachedProfile = JSON.parse(localStorage.getItem(`profile_${currentUser.uid}`)) || {};
                cachedProfile.username = username;
                cachedProfile.bio = bio;
                localStorage.setItem(`profile_${currentUser.uid}`, JSON.stringify(cachedProfile));

                editProfileModal.classList.remove('active');
            } catch (error) {
                console.error('Ошибка сохранения профиля:', error);
                alert('Не удалось сохранить профиль!');
            } finally {
                loadingOverlay.classList.remove('active');
            }
        });

        // Навигация
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const navText = item.querySelector('.nav-text').textContent;
                if (navText === 'Главное') {
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    window.location.href = 'index.html';
                } else if (navText === 'Лидеры') {
                    alert('Переход на страницу лидеров (заглушка)!');
                }
            });
        });

        // Обработчики кнопок настроек
        settingsButton.addEventListener('click', () => {
            alert('Настройки пока не реализованы!');
        });

        favoritesButton.addEventListener('click', () => {
            alert('Избранное пока не реализовано!');
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                localStorage.removeItem(`profile_${currentUser.uid}`);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Ошибка выхода:', error);
                alert('Не удалось выйти!');
            }
        });

        // Рендеринг поста
        function renderPost(postData, postId, prepend = false) {
            const post = document.createElement('div');
            post.classList.add('post');
            post.dataset.createdAt = postData.createdAt;
            post.dataset.id = postId;

            const postHeader = document.createElement('div');
            postHeader.classList.add('post-header');

            const postAvatar = document.createElement('img');
            postAvatar.classList.add('post-avatar');
            postAvatar.src = profileAvatar.src;
            postAvatar.alt = 'avatar';
            postHeader.appendChild(postAvatar);

            const headerInfo = document.createElement('div');
            const postUsernameContainer = document.createElement('div');
            postUsernameContainer.classList.add('post-username-container');
            
            const postUsernameElement = document.createElement('div');
            postUsernameElement.classList.add('post-username');
            postUsernameElement.textContent = profileUsername.textContent;
            postUsernameContainer.appendChild(postUsernameElement);

            if (profileVerified.style.display === 'block') {
                const verifiedIcon = document.createElement('img');
                verifiedIcon.classList.add('post-verified');
                verifiedIcon.src = 'https://img.icons8.com/color/48/instagram-verification-badge.png';
                verifiedIcon.alt = 'verified';
                postUsernameContainer.appendChild(verifiedIcon);
            }

            headerInfo.appendChild(postUsernameContainer);

            const postTime = document.createElement('div');
            postTime.classList.add('post-time');
            postTime.textContent = '0 сек назад';
            headerInfo.appendChild(postTime);

            postHeader.appendChild(headerInfo);
            post.appendChild(postHeader);

            if (postData.imageUrl) {
                const postImage = document.createElement('img');
                postImage.classList.add('post-image');
                postImage.src = postData.imageUrl;
                postImage.alt = 'post image';
                post.appendChild(postImage);
            }

            if (postData.title) {
                const postTitleElement = document.createElement('div');
                postTitleElement.classList.add('post-title');
                postTitleElement.textContent = postData.title;
                post.appendChild(postTitleElement);
            }

            if (postData.text) {
                const postTextElement = document.createElement('div');
                postTextElement.classList.add('post-text');
                postTextElement.textContent = postData.text;
                post.appendChild(postTextElement);
            }

            const postActions = document.createElement('div');
            postActions.classList.add('post-actions');

            const likeAction = document.createElement('div');
            likeAction.classList.add('action-item');
            const likeIcon = document.createElement('img');
            likeIcon.src = 'https://img.icons8.com/ios/50/ffffff/like--v1.png';
            likeIcon.alt = 'like';
            const likeCount = document.createElement('span');
            likeCount.textContent = '0';
            likeAction.appendChild(likeIcon);
            likeAction.appendChild(likeCount);
            postActions.appendChild(likeAction);

            const dislikeAction = document.createElement('div');
            dislikeAction.classList.add('action-item');
            const dislikeIcon = document.createElement('img');
            dislikeIcon.src = 'https://img.icons8.com/ios/50/ffffff/dislike--v1.png';
            dislikeIcon.alt = 'dislike';
            const dislikeCount = document.createElement('span');
            dislikeCount.textContent = '0';
            dislikeAction.appendChild(dislikeIcon);
            dislikeAction.appendChild(dislikeCount);
            postActions.appendChild(dislikeAction);

            const commentAction = document.createElement('div');
            commentAction.classList.add('action-item');
            const commentIcon = document.createElement('img');
            commentIcon.src = 'https://img.icons8.com/ios/50/ffffff/comments--v1.png';
            commentIcon.alt = 'comment';
            const commentCount = document.createElement('span');
            commentCount.textContent = postData.comments || 0;
            commentAction.appendChild(commentIcon);
            commentAction.appendChild(commentCount);
            postActions.appendChild(commentAction);

            post.appendChild(postActions);

            commentAction.addEventListener('click', () => {
                alert('Комментарии пока не реализованы!');
            });

            if (prepend) {
                userPosts.prepend(post);
            } else {
                userPosts.appendChild(post);
            }
        }

        // Отписка перед закрытием страницы
        window.addEventListener('beforeunload', () => {
            if (unsubscribeSnapshot) unsubscribeSnapshot();
        });
    </script>
</body>
</html>
