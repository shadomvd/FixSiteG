<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>FixWorked</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/images/icon.png" type="image/png" />
  <link rel="apple-touch-icon" href="assets/images/icon.png" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      background-attachment: fixed;
      background-size: cover;
      overflow: hidden;
      touch-action: manipulation;
    }

    body {
      display: flex;
      flex-direction: column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .fixworked-top-banner {
      position: fixed;
      top: calc(10px + env(safe-area-inset-top));
      left: 50%;
      transform: translateX(-50%);
      background-color: #ffffff20;
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: clamp(12px, 3.5vw, 14px);
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      width: clamp(200px, 80%, 300px);
      text-align: center;
    }

    .fixworked-top-banner-back {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .fixworked-top-banner-back:active {
      transform: translateY(-50%) scale(1.2) rotate(90deg);
    }

    .fixworked-chat-container {
      flex: 1;
      overflow-y: auto;
      padding: calc(50px + env(safe-area-inset-top)) 8px calc(60px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      min-height: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .fixworked-message {
      max-width: 80%;
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: clamp(12px, 3.5vw, 13px);
      line-height: 1.4;
      word-break: break-word;
      white-space: normal;
      display: inline-block;
    }

    .fixworked-message.support {
      background: linear-gradient(135deg, #2f2f5e, #4a4a8a);
      margin-right: auto;
      margin-left: 8px;
    }

    .fixworked-message.user {
      background: linear-gradient(135deg, #3b3b6b, #5a5a9a);
      margin-left: auto;
      margin-right: 8px;
    }

    .fixworked-message-content {
      display: block;
      max-width: 100%;
    }

    .fixworked-message-time {
      display: block;
      font-size: clamp(8px, 2.5vw, 9px);
      color: #a0a0a0;
      margin-top: 3px;
      text-align: right;
    }

    .fixworked-input-container {
      position: fixed;
      bottom: env(safe-area-inset-bottom);
      left: 0;
      right: 0;
      height: 55px;
      background: linear-gradient(135deg, #1f1f3a, #2f2f5e);
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: flex;
      align-items: center;
      padding: 0 8px;
    }

    .fixworked-input-container img {
      width: clamp(24px, 6vw, 26px);
      height: clamp(24px, 6vw, 26px);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .fixworked-input-container img:active {
      transform: scale(1.2);
    }

    .fixworked-input-field {
      flex: 1;
      background-color: #ffffff20;
      border: none;
      border-radius: 14px;
      padding: 8px 12px;
      margin: 0 8px;
      color: #fff;
      font-size: clamp(11px, 3.5vw, 12px);
      outline: none;
    }

    .fixworked-input-field::placeholder {
      color: #a0a0a0;
    }

    /* Адаптивность */
    @media (max-width: 480px) {
      .fixworked-chat-container {
        padding: calc(45px + env(safe-area-inset-top)) 6px calc(55px + env(safe-area-inset-bottom));
      }

      .fixworked-input-container {
        height: 50px;
        padding: 0 6px;
      }
    }

    @media (min-width: 769px) {
      .fixworked-top-banner, .fixworked-input-container, .fixworked-chat-container {
        display: none;
      }

      body::after {
        content: 'Пожалуйста, откройте приложение на мобильном устройстве';
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #fff;
        font-size: 18px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="fixworked-top-banner">
    <img src="assets/images/back.svg" alt="Назад" class="fixworked-top-banner-back" onclick="goBack()" />
    FixSupport
  </div>
  <div class="fixworked-chat-container" onclick="hideKeyboard()">
    <div class="fixworked-message support">
      <span class="fixworked-message-content">Здравствуйте! Спасибо, что обратились в службу поддержки. Чем можем помочь?</span>
      <span class="fixworked-message-time" id="support-message-time"></span>
    </div>
  </div>
  <div class="fixworked-input-container">
    <img src="assets/images/image.svg" alt="Фото" onclick="selectPhoto()" />
    <input type="text" class="fixworked-input-field" placeholder="Введите сообщение..." maxlength="1000" />
    <img src="assets/images/send.svg" alt="Отправить" onclick="sendMessage()" />
  </div>
  <script>
    // Функция для экранирования HTML
    function escapeHTML(str) {
      try {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      } catch (error) {
        console.error('Ошибка экранирования:', error);
        return str.replace(/[&<>"']/g, (m) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m]));
      }
    }

    // Безопасное выполнение функций
    function safeExecute(fn) {
      try {
        return fn();
      } catch (error) {
        console.error('Ошибка выполнения:', error);
        return null;
      }
    }

    function goBack() {
      safeExecute(() => {
        window.history.back();
      });
    }

    function selectPhoto() {
      safeExecute(() => {
        alert('Выбор фото пока не реализован');
      });
    }

    function hideKeyboard() {
      safeExecute(() => {
        document.activeElement.blur();
      });
    }

    function sendMessage() {
      safeExecute(() => {
        const input = document.querySelector('.fixworked-input-field');
        let messageText = input.value.trim();

        if (!messageText) return;

        // Санитизируем ввод
        messageText = escapeHTML(messageText);

        const chatContainer = document.querySelector('.fixworked-chat-container');
        const newMessage = document.createElement('div');
        newMessage.classList.add('fixworked-message', 'user');
        newMessage.innerHTML = `<span class="fixworked-message-content">${messageText}</span><span class="fixworked-message-time">${getCurrentTime()}</span>`;
        chatContainer.appendChild(newMessage);
        input.value = '';
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
    }

    function getCurrentTime() {
      return safeExecute(() => {
        const now = new Date();
        return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      }) || '00:00';
    }

    // Инициализация времени первого сообщения
    safeExecute(() => {
      document.getElementById('support-message-time').textContent = getCurrentTime();
    });

    // Автоматическая прокрутка при открытии клавиатуры
    window.addEventListener('resize', () => {
      safeExecute(() => {
        const chatContainer = document.querySelector('.fixworked-chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
    });

    // Блокировка скриптов с помощью MutationObserver
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeName === 'SCRIPT') {
            node.parentNode.removeChild(node);
            console.warn('Попытка вставки скрипта заблокирована');
          }
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  </script>
</body>
</html>
